---
title: "Resultados_DenoisingWavelet"
author: "hectortorresmuñoz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE}
library(imager)
library(waveslim)

carpeta_clean <- "fotos_clean"
carpeta_ruido <- "fotos_ruido"

#asegurar 3 canales
to_rgb <- function(img){
  if (spectrum(img) == 1) {
    img <- imappend(list(img,img,img), axis = "c")
  }
  img
}


#  FUNCIONES DE JOAN tal cual


eliminate <- function(wR,wG,wB,mode) {
  
  if (mode == 'all') {
    
    for (j in 1:(length(wR)-1)) {
    
      wR[[j]] <- 0*wR[[j]]
      wG[[j]] <- 0*wG[[j]]
      wB[[j]] <- 0*wB[[j]]
    
    }
  }
  
  else if (mode == 'diag') {
    
    for (j in 1:(length(wR)-1)) {
      
      if (j %% 3 == 0) {
    
        wR[[j]] <- 0*wR[[j]]
        wG[[j]] <- 0*wG[[j]]
        wB[[j]] <- 0*wB[[j]]
      }
    }
    
  }
  
  return(list(R = wR,G = wG,B = wB))
}

plot_err <- function(img,img_noise,max_lev=8,wf='la8',mode = 'all') {
  
  R_T <- img[,,,1]
  G_T <- img[,,,2]
  B_T <- img[,,,3]
  
  R <- img_noise[,,,1]
  G <- img_noise[,,,2]
  B <- img_noise[,,,3]
  
  err <- c()
  
  for (i in 1:max_lev) {
    
    wR <- dwt.2d(R, wf = wf, J = i)
    wG <- dwt.2d(G, wf = wf, J = i)
    wB <- dwt.2d(B, wf = wf, J = i)
    
    res <- eliminate(wR,wG,wB,mode)
    
    wR <- res$R
    wG <- res$G
    wB <- res$B
    
    R_rec <- idwt.2d(wR)
    G_rec <- idwt.2d(wG)
    B_rec <- idwt.2d(wB)
      
    err_R <- sum((R_T-R_rec)**2)
    err_G <- sum((G_T-G_rec)**2)
    err_B <- sum((B_T-B_rec)**2)
    
    err[i] <- (1/(3*nrow(R)*ncol(R))*(err_R+err_G+err_B))**0.5
  }

  plot(1:max_lev, err, col = 'red', 
       xlab='Niveles de la DWT',ylab='RMSE', 
       main=paste0('Error en función del nivel para wf = ',wf, 
                   ' y modo = ', mode))
}

plot_comp <- function(img,img_noise,opt_lev, wf='la8', mode = 'all') {
  
  R <- img_noise[,,,1]
  G <- img_noise[,,,2]
  B <- img_noise[,,,3]
  
  wR <- dwt.2d(R, wf = wf, J = opt_lev)
  wG <- dwt.2d(G, wf = wf, J = opt_lev)
  wB <- dwt.2d(B, wf = wf, J = opt_lev)
    
  res <- eliminate(wR,wG,wB,mode)
    
  wR <- res$R
  wG <- res$G
  wB <- res$B
  
  R_rec <- idwt.2d(wR)
  G_rec <- idwt.2d(wG)
  B_rec <- idwt.2d(wB)
      
  img_rec <- imappend(list(as.cimg(R_rec), as.cimg(G_rec),
                         as.cimg(B_rec)), axis = "c")
  
  par(mfrow = c(2, 2), mar = c(1, 1, 1, 1))
  plot(img, main='Original',axes=FALSE)
  plot(img_noise, main='Con ruido',axes=FALSE)
  plot(img_rec, main= 'DWT óptima',axes=FALSE)
}


# Esto es lo mismo que la funcion de Joan de plot_err pero DEVUELVE err que nos hace falta más adelante

get_err <- function(img,img_noise,max_lev=8,wf='la8',mode='all') {
  
  R_T <- img[,,,1]; G_T <- img[,,,2]; B_T <- img[,,,3]
  R <- img_noise[,,,1]; G <- img_noise[,,,2]; B <- img_noise[,,,3]
  
  err <- numeric(max_lev)
  
  for (i in 1:max_lev) {
    wR <- dwt.2d(R, wf = wf, J = i)
    wG <- dwt.2d(G, wf = wf, J = i)
    wB <- dwt.2d(B, wf = wf, J = i)
    
    res <- eliminate(wR,wG,wB,mode)
    R_rec <- idwt.2d(res$R)
    G_rec <- idwt.2d(res$G)
    B_rec <- idwt.2d(res$B)
    
    err_R <- sum((R_T-R_rec)^2)
    err_G <- sum((G_T-G_rec)^2)
    err_B <- sum((B_T-B_rec)^2)
    
    err[i] <- sqrt((err_R + err_G + err_B)/(3*nrow(R)*ncol(R)))
  }
  
  err
}

# Parseo de nombres ruido -> base / noise
parse_noise_file <- function(path){
  name <- tools::file_path_sans_ext(basename(path))
  noise <- sub(".*_(gauss|sp|poisson|speckle)$", "\\1", name)
  base  <- sub("_(gauss|sp|poisson|speckle)$", "", name)
  list(base=base, noise=noise, name=name)
}

```

---

## 2) Batch: aplicar `plot_err`/`plot_comp` (con `opt_lev` calculado) a todas las imágenes

Este chunk hace exactamente esto para **cada imagen con ruido**:
- carga `clean` y `noisy`
- calcula `err_all` y `err_diag` con `get_err()`
- obtiene `opt_lev_all` y `opt_lev_diag`
- guarda una tabla de resultados (para luego comentar)
- (opcional) genera plots solo para una imagen “representativa” por ruido (para no inundar el HTML)

```{r}
max_lev <- 6
wf <- "la8"

files_ruido <- list.files(carpeta_ruido, pattern="\\.jpg$", full.names=TRUE, ignore.case=TRUE)

# Tabla donde guardaremos resultados por imagen-ruido
results <- data.frame(
  base=character(), noise=character(),
  opt_all=integer(), rmse_min_all=double(),
  opt_diag=integer(), rmse_min_diag=double(),
  stringsAsFactors = FALSE
)

for (f in files_ruido) {
  p <- parse_noise_file(f)
  f_clean <- file.path(carpeta_clean, paste0("clean_", p$base, ".jpg"))
  if (!file.exists(f_clean)) next
  
  img <- to_rgb(load.image(f_clean))
  img_noise <- to_rgb(load.image(f))
  
  # Curvas (numéricas) usando lo de Joan
  err_all  <- get_err(img, img_noise, max_lev=max_lev, wf=wf, mode="all")
  err_diag <- get_err(img, img_noise, max_lev=max_lev, wf=wf, mode="diag")
  
  # Nivel óptimo por modo
  opt_all  <- which.min(err_all)
  opt_diag <- which.min(err_diag)
  
  results <- rbind(
    results,
    data.frame(
      base=p$base, noise=p$noise,
      opt_all=opt_all,   rmse_min_all=min(err_all),
      opt_diag=opt_diag, rmse_min_diag=min(err_diag),
      stringsAsFactors = FALSE
    )
  )
}

results
```


---

## 3) Figuras: aplicar `plot_err` y `plot_comp` (1 ejemplo por ruido) + Guardado de los outputs

Como el informe normalmente no necesita 32×(varias figuras), este chunk elige:
- una `base_ej` (la primera que exista)
- y para cada ruido (`gauss, sp, poisson, speckle`) dibuja:
  1) `plot_err(... mode="all")`
  2) `plot_err(... mode="diag")`
  3) `plot_comp(... opt_lev_all, mode="all")`
  4) `plot_comp(... opt_lev_diag, mode="diag")`

```{r}

dir_out <- "fotos_informe"
if (!dir.exists(dir_out)) dir.create(dir_out)

# Elegimos una imagen base representativa ---> luego lo cambio para que lo haga con todas las imagenes en lugar de solo con una 
base_ej <- unique(results$base)[2]

for (nz in c("gauss","sp","poisson","speckle")) {
  f_clean <- file.path(carpeta_clean, paste0("clean_", base_ej, ".jpg"))
  f_noisy <- file.path(carpeta_ruido, paste0(base_ej, "_", nz, ".jpg"))
  if (!file.exists(f_clean) || !file.exists(f_noisy)) next
  
  img <- to_rgb(load.image(f_clean))
  img_noise <- to_rgb(load.image(f_noisy))
  
  # Recuperar óptimos precalculados
  opt_all  <- results$opt_all [results$base==base_ej & results$noise==nz][1]
  opt_diag <- results$opt_diag[results$base==base_ej & results$noise==nz][1]
  
  oldpar <- par(no.readonly = TRUE)
  on.exit(par(oldpar), add = TRUE)

  # 1) Curva RMSE (all) - plot separado + ruido
  #jpg
  jpeg(file.path(dir_out, paste0(base_ej,"_",nz,"_rmse_all.jpg")), 
       width=8, height=5, units="in", res=300)
    par(mfrow = c(1,1), mar = c(5,4,4,2) + 0.1, oma = c(0,0,2,0))
    plot_err(img, img_noise, max_lev = max_lev, wf = wf, mode = "all")
    mtext(paste0("Ruido: ", nz, " | Modo: all"), outer = TRUE, cex = 1)
  dev.off()
  
  #rmd
  par(mfrow = c(1,1), mar = c(5,4,4,2) + 0.1, oma = c(0,0,2,0))
  plot_err(img, img_noise, max_lev = max_lev, wf = wf, mode = "all")
  mtext(paste0("Ruido: ", nz, " | Modo: all"), outer = TRUE, cex = 1)

 
  # 2) Curva RMSE (diag) - plot separado + ruido
  #jpg
  jpeg(file.path(dir_out, paste0(base_ej,"_",nz,"_rmse_diag.jpg")), 
       width=8, height=5, units="in", res=300)
    par(mfrow = c(1,1), mar = c(5,4,4,2) + 0.1, oma = c(0,0,2,0))
    plot_err(img, img_noise, max_lev = max_lev, wf = wf, mode = "diag")
    mtext(paste0("Ruido: ", nz, " | Modo: diag"), outer = TRUE, cex = 1)
  dev.off()
  
  #rmd
  par(mfrow = c(1,1), mar = c(5,4,4,2) + 0.1, oma = c(0,0,2,0))
  plot_err(img, img_noise, max_lev = max_lev, wf = wf, mode = "diag")
  mtext(paste0("Ruido: ", nz, " | Modo: diag"), outer = TRUE, cex = 1)

 
  # 3) Comparación (all) - plot separado + ruido y modo
  par(oldpar)
  #jpg
  jpeg(file.path(dir_out, paste0(base_ej,"_",nz,"_comp_all.jpg")), 
       width=8, height=6, units="in", res=300)
    par(oma = c(0,0,2,0)) 
    plot_comp(img, img_noise, opt_lev = opt_all, wf = wf, mode = "all")
    mtext(paste0("Ruido: ", nz, " | Modo: all | opt_lev: ", opt_all), outer = TRUE, cex = 1)
  dev.off()
  
  #rmd
  par(oma = c(0,0,2,0)) 
  plot_comp(img, img_noise, opt_lev = opt_all, wf = wf, mode = "all")
  mtext(paste0("Ruido: ", nz, " | Modo: all | opt_lev: ", opt_all),
        outer = TRUE, cex = 1)

  # 4) Comparación (diag) - plot separado + ruido y modo
  par(oldpar)
  #jpg
  jpeg(file.path(dir_out, paste0(base_ej,"_",nz,"_comp_diag.jpg")), 
       width=8, height=6, units="in", res=300)
    par(oma = c(0,0,2,0))
    plot_comp(img, img_noise, opt_lev = opt_diag, wf = wf, mode = "diag")
    mtext(paste0("Ruido: ", nz, " | Modo: diag | opt_lev: ", opt_diag), outer = TRUE, cex = 1)
  dev.off()
  
  #rmd
  par(oma = c(0,0,2,0))
  plot_comp(img, img_noise, opt_lev = opt_diag, wf = wf, mode = "diag")
  mtext(paste0("Ruido: ", nz, " | Modo: diag | opt_lev: ", opt_diag),
        outer = TRUE, cex = 1)
}

```




































